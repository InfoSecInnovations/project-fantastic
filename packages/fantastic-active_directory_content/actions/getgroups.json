{
  "name": "Get ActiveDirectory Groups",
  "description": "List all groups in the Security category",
  "hosts": ["local"],
  "functions": {
    "run": {
      "command": "Get-ADGroup -Filter 'GroupCategory -eq \"Security\"'",
      "method": "invoke",
      "json": true,
      "result": {
        "label": "Name",
        "followups": [
          {
            "function": "get_users",
            "data": {
              "identity": "Name"
            }
          }
        ]
      }
    },
    "get_users": {
      "name": "Get Users",
      "command": "Get-ADGroupMember -Identity $identity -Recursive | where objectClass -eq user | Get-ADUser",
      "method": "invoke",
      "json": true,
      "result": {
        "label": "Name",
        "followups": [
          {
            "function": "reset_password",
            "data": {
              "identity": "Name"
            }
          },
          {
            "function": "enable_user",
            "data": {
              "identity": "Name",
              "state": {"bool": "Enabled", "inverse": true}
            },
            "enabled": {"bool": "Enabled"}
          }
        ]
      }
    },
    "reset_password": {
      "name": "Reset Password",
      "command": "Set-ADUser -Identity $identity -ChangePasswordAtLogon $true",
      "method": "invoke"
    },
    "enable_user": {
      "name": "Enable User",
      "command": "Set-ADUser -Identity $identity -Enabled $state",
      "method": "invoke"
    }
  }
}